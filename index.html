<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Quay s·ªë tr√∫ng th∆∞·ªüng</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      gap: 1rem;
      min-height: 100vh;
      background: #ffffff;
      background-size: cover;
      font-family: sans-serif;
      margin: 0;
      padding: 1rem;
      box-sizing: border-box;
    }
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      background: transparent;
      width: 100%;
      max-width: 500px;
    }
    .panel {
      border-radius: 1rem;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.75rem;
      width: 100%;
      box-sizing: border-box;
    }
    .setup-panel {
      background: rgba(255, 255, 255, 0.9);
    }
    .play-panel {
      display: none;
      position: relative;
    }
    textarea {
      width: 100%; 
      max-width: 400px;
      height: 120px;
      box-sizing: border-box;
    }
    .button {
      background: #2563eb;
      color: #fff;
      font-weight: bold;
      padding: 0.8rem 1.5rem;
      border-radius: 9999px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      border: none;
      cursor: pointer;
      font-size: 1rem;
      transition: background-color 0.2s;
    }
    .button:hover {
        opacity: 0.9;
    }
    .wheel-container {
      position: relative;
      margin-top: 1rem;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
    }
    .arrow-top {
      position: absolute;
      top: -25px;
      left: 50%;
      transform: translateX(-50%) rotate(180deg);
      width: 0;
      height: 0;
      border-left: 15px solid transparent;
      border-right: 15px solid transparent;
      border-bottom: 25px solid red;
      z-index: 10;
    }
    .wheel {
      width: 85vw;
      max-width: 420px; 
      aspect-ratio: 1 / 1;
      border: 4px solid #ccc;
      border-radius: 50%;
      overflow: hidden;
      position: relative;
    }
    .start-button {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 5;
      font-size: 1.2rem;
      padding: 0.8rem 1.2rem;
    }
    .result {
      display: inline-block;
      margin-top: 1rem;
      font-size: 1.1rem;
      font-weight: bold;
      color: #ef4444;
      text-align: center;
      background: #fff;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
      max-width: 90vw;
      white-space: pre-line;
    }
    #history {
      margin-top: 1rem;
      width: 100%; 
      max-width: 400px;
      text-align: left;
      font-size: 0.9rem;
      color: #374151;
    }
    .confetti {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    }
    .control-buttons-row {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 0.5rem;
      width: 100%;
      margin-top: 1.5rem;
      flex-wrap: wrap;
    }
    .control-buttons-row .button {
      flex: 1 1 auto;
      min-width: 80px;
      padding: 0.6rem 0.5rem;
      font-size: 0.9rem;
    }
    #clear-history {
      background: #ef4444;
    }
    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    #toggle-controls-btn {
        background-color: #6b7280;
        flex-grow: 0;
        flex-basis: 44px;
        width: 44px;
        height: 44px;
        padding: 0;
        border-radius: 50%;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .device-choice-container {
        display: flex;
        gap: 1rem;
        align-items: center;
        margin-top: 1rem;
        padding: 0.5rem;
        border: 1px solid #ddd;
        border-radius: 0.5rem;
    }
    .device-choice-container > div {
        display: flex;
        gap: 0.25rem;
        align-items: center;
    }
  </style>
</head>
<body>
<audio id="spin-sound" src="wheel_spin.mp3" preload="auto"></audio>

<div class="container">
  <div id="setup" class="panel setup-panel">
    <textarea id="prize-input" placeholder="Nh·∫≠p gi·∫£i theo ƒë·ªãnh d·∫°ng: t√™n gi·∫£i|s·ªë l∆∞·ª£ng|tr·ªçng s·ªë|m√£ m√†u&#10;V√≠ d·ª•:&#10;Gi·∫£i A|3|5|#FF0000&#10;Gi·∫£i B|2|1|blue&#10;Gi·∫£i C|1|1|rgb(0,255,0)&#10;Gi·∫£i D|5||hsl(60,100%,50%) (tr·ªçng s·ªë m·∫∑c ƒë·ªãnh l√† 1)&#10;Gi·∫£i E|10|3|#00FFFF&#10;ƒê·ªÉ tr·ªëng tr·ªçng s·ªë, s·ª≠ d·ª•ng 2 d·∫•u g·∫°ch ƒë·ª©ng li√™n ti·∫øp (||)"></textarea>
    <button class="button" id="update-button">C·∫≠p nh·∫≠t gi·∫£i</button>
    
    <div class="checkbox-container">
      <input type="checkbox" id="show-zero-quantity">
      <label for="show-zero-quantity">Hi·ªÉn th·ªã gi·∫£i th∆∞·ªüng h·∫øt h√†ng</label>
    </div>

    <input type="file" id="bg-file" accept="image/*" style="display: none;">
    <button class="button" id="bg-button">Ch·ªçn ·∫£nh n·ªÅn</button>
    
    <div class="device-choice-container">
      <label>Ch·∫ø ƒë·ªô:</label>
      <div>
        <input type="radio" id="mode-pc" name="device-mode" value="pc">
        <label for="mode-pc">PC</label>
      </div>
      <div>
        <input type="radio" id="mode-mobile" name="device-mode" value="mobile" checked>
        <label for="mode-mobile">Mobile</label>
      </div>
    </div>

    <button class="button" id="ready-button">Ready</button>
  </div>

  <div id="play" class="panel play-panel">
    <canvas class="confetti" id="confetti"></canvas>
    <div class="wheel-container">
      <div class="arrow-top"></div>
      <div class="wheel" id="wheel">
        <svg id="wheel-svg" viewBox="0 0 200 200" width="100%" height="100%"></svg>
      </div>
      <button class="button start-button" id="start-button">Quay</button>
    </div>
    <div class="result" id="result"></div>
    <div id="history"><strong>L·ªãch s·ª≠ tr√∫ng th∆∞·ªüng:</strong><ul id="history-list"></ul></div>
    
    <div class="control-buttons-row">
      <button id="download-history" class="button control-btn">History</button>
      <button id="clear-history" class="button control-btn">X√≥a l·ªãch s·ª≠</button>
      <button id="setup-button" class="button control-btn">Setup</button>
      <!-- === N√öT FULL SCREEN M·ªöI === -->
      <button id="fullscreen-btn" class="button control-btn">Full screen</button>
      <button id="toggle-controls-btn" class="button" title="·∫®n/hi·ªán c√°c n√∫t ch·ª©c nƒÉng (Ph√≠m F1)">üëÅÔ∏è</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
<script>
let prizes = [];
let lastRotation = 0;
let spinning = false;
let historyData = [];
let spinSound;
let showZeroQuantityPrizes = false;
let showControlButtons = true;

function saveHistoryToLocalStorage() {
  if (historyData.length === 0) return;
  const header = "Thoi gian, Giai thuong\n";
  const rows = historyData.map(item => `${item.time},${item.prize}`).join("\n");
  const csvContent = header + rows;
  localStorage.setItem("lich_su_trung_thuong_csv", csvContent);
}

function downloadHistoryAsCSV() {
  let csvContent = localStorage.getItem("lich_su_trung_thuong_csv");
  if (!csvContent) return;
  
  const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'lich_su_trung_thuong.csv';
  a.click();
  URL.revokeObjectURL(url);
}

function restoreHistoryFromLocalStorage() {
  let csvContent = localStorage.getItem("lich_su_trung_thuong_csv");
  if (!csvContent) return;
  let lines = csvContent.trim().split("\n");
  lines = lines.slice(1);
  historyData = [];
  lines.forEach(line => {
    const [time, prize] = line.split(",");
    if (time && prize) historyData.push({ time: time.trim(), prize: prize.trim() });
  });
  if (historyData.length > 0) {
    const last = historyData[historyData.length - 1];
    const ul = document.getElementById("history-list");
    ul.innerHTML = "";
    const li = document.createElement("li");
    li.textContent = `${last.time} - ${last.prize}`;
    ul.appendChild(li);
    document.getElementById("result").textContent = `Ch√∫c m·ª´ng b·∫°n ƒë√£ tr√∫ng: ${last.prize}`;
  }
}

function updateWheel() {
  const input = document.getElementById("prize-input").value;
  prizes = input.split("\n").map(l => {
    const parts = l.split("|").map(x => x.trim());
    const label = parts[0];
    const count = parseInt(parts[1]);
    const weight = (parts[2] && !isNaN(parseFloat(parts[2]))) ? parseFloat(parts[2]) : 1;
    const customColor = (parts[3] && parts[3] !== '') ? parts[3] : undefined;
    
    return { label: label, count: count, weight: weight, customColor: customColor };
  }).filter(p => p.label && !isNaN(p.count));
  
  drawWheel();
}

function drawWheel() {
  const svg = document.getElementById("wheel-svg");
  if (!svg) return;
  svg.innerHTML = "";
  
  const prizesToDraw = showZeroQuantityPrizes ? prizes : prizes.filter(p => p.count > 0);

  if (prizesToDraw.length === 0) return;

  const slice = 360 / prizesToDraw.length;
  prizesToDraw.forEach((p, i) => {
    const s = i * slice,
          e = s + slice;
    const color = p.customColor || `hsl(${(i * 360) / prizesToDraw.length},70%,50%)`;
    const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
    const laf = slice > 180 ? 1 : 0;
    const x1 = 100 + 100 * Math.cos(((s - 90) * Math.PI) / 180);
    const y1 = 100 + 100 * Math.sin(((s - 90) * Math.PI) / 180);
    const x2 = 100 + 100 * Math.cos(((e - 90) * Math.PI) / 180);
    const y2 = 100 + 100 * Math.sin(((e - 90) * Math.PI) / 180);
    path.setAttribute("d", `M100,100 L${x1},${y1} A100,100 0 ${laf} 1 ${x2},${y2} Z`);
    path.setAttribute("fill", color);
    svg.appendChild(path);

    const ta = s + slice / 2;
    const tx = 100 + 60 * Math.cos(((ta - 90) * Math.PI) / 180);
    const ty = 100 + 60 * Math.sin(((ta - 90) * Math.PI) / 180);
    const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
    text.setAttribute("x", tx);
    text.setAttribute("y", ty);
    text.setAttribute("fill", "white");
    const fontSize = prizesToDraw.length > 10 ? 8 : 10;
    text.setAttribute("font-size", fontSize);
    text.setAttribute("font-weight", "bold");
    text.setAttribute("text-anchor", "middle");
    text.setAttribute("alignment-baseline", "middle");
    text.setAttribute("transform", `rotate(${ta}, ${tx}, ${ty})`);
    text.textContent = p.label;
    svg.appendChild(text);
  });
}

function pickPrizeIndexByCount() {
  const availablePrizes = prizes.filter(p => p.count > 0);
  
  if (availablePrizes.length === 0) {
    return -1;
  }

  const total = availablePrizes.reduce((acc, p) => acc + p.count * p.weight, 0);

  if (total === 0) {
    return -1;
  }
  
  let r = Math.random() * total;  
  
  for (let i = 0; i < availablePrizes.length; i++) {
    const currentPrizeWeight = availablePrizes[i].count * availablePrizes[i].weight;
    
    r -= currentPrizeWeight;
    
    if (r <= 0) {
      return prizes.findIndex(p => p.label === availablePrizes[i].label);
    }
  }
  
  return -1;  
}

function spinWheel() {
  if (prizes.length === 0 || spinning) return;
  
  const targetIndex = pickPrizeIndexByCount();
  if (targetIndex === -1) {
    alert("Kh√¥ng c√≤n gi·∫£i th∆∞·ªüng n√†o ƒë·ªÉ quay!");
    return;
  }

  spinning = true;
  const wheel = document.getElementById("wheel");
  const resultBox = document.getElementById("result");
  resultBox.textContent = "";
  
  const prizesForSpinCalculation = showZeroQuantityPrizes ? prizes : prizes.filter(p => p.count > 0);
  if (prizesForSpinCalculation.length === 0) {
    alert("Kh√¥ng c√≥ gi·∫£i th∆∞·ªüng n√†o hi·ªÉn th·ªã tr√™n v√≤ng quay!");
    spinning = false;
    return;
  }
  const slice = 360 / prizesForSpinCalculation.length;

  const spinRounds = Math.floor(Math.random() * 3) + 5;

  const currentRotation = lastRotation % 360;
  const targetPrizeInSpinArray = prizesForSpinCalculation.find(p => p.label === prizes[targetIndex].label);
  const targetPrizeIndexInSpinArray = prizesForSpinCalculation.indexOf(targetPrizeInSpinArray);
  
  const randomOffset = (Math.random() - 0.5) * (slice * 0.8);
  const targetAngle = (targetPrizeIndexInSpinArray * slice) + (slice / 2) + randomOffset;
  
  let rotationToTop = 360 - targetAngle - currentRotation;
  rotationToTop = (rotationToTop + 360) % 360;
  const rotationAmount = spinRounds * 360 + rotationToTop;
  lastRotation += rotationAmount;

  const durationSec = Math.random() * 2 + 5;
  const durationMs = durationSec * 1000;
  wheel.style.transition = `transform ${durationSec}s cubic-bezier(0.25, 0.1, 0.25, 1)`;
  wheel.style.transform = `rotate(${lastRotation}deg)`;

  if (spinSound) {
    spinSound.currentTime = 0;
    spinSound.play().catch(e => console.error("L·ªói khi ph√°t √¢m thanh:", e));
  }

  setTimeout(() => {
    if (spinSound) {
      spinSound.pause();
      spinSound.currentTime = 0;
    }

    const prize = prizes[targetIndex];
    const timestamp = new Date().toLocaleTimeString();
    resultBox.textContent = `Ch√∫c m·ª´ng b·∫°n ƒë√£ tr√∫ng: ${prize.label}`;
    prize.count--;
    
    drawWheel();

    const ul = document.getElementById("history-list");
    ul.innerHTML = "";
    const li = document.createElement("li");
    li.textContent = `${timestamp} - ${prize.label}`;
    ul.appendChild(li);

    historyData.push({ time: timestamp, prize: prize.label });
    saveHistoryToLocalStorage();

    if (window.confetti) {
        confetti({
          particleCount: 150,
          spread: 70,
          origin: { y: 0.6 },
        });
    }

    spinning = false;
  }, durationMs + 100);
}

function updateBackgroundFromFile() {
  const file = document.getElementById('bg-file').files[0];
  if (file) {
    const r = new FileReader();
    r.onload = (e) => {
      document.body.style.backgroundImage = `url('${e.target.result}')`;
    };
    r.readAsDataURL(file);
  }
}

function startGame() {
  const isPCMode = document.getElementById('mode-pc').checked;

  document.getElementById('setup').style.display = 'none';
  document.getElementById('play').style.display = 'flex';
  
  const toggleBtn = document.getElementById('toggle-controls-btn');
  if (isPCMode) {
    toggleBtn.style.display = 'none';
  } else {
    toggleBtn.style.display = 'flex';
  }
  
  updateWheel();
}

function backToSetup() {
  document.getElementById('play').style.display = 'none';
  document.getElementById('setup').style.display = 'flex';
}

function toggleControlButtons() {
    showControlButtons = !showControlButtons;
    
    const buttonsToToggle = document.querySelectorAll('.control-btn');
    buttonsToToggle.forEach(btn => {
        btn.style.display = showControlButtons ? "" : "none";
    });
    
    const toggleBtn = document.getElementById('toggle-controls-btn');
    if (toggleBtn) {
        toggleBtn.textContent = showControlButtons ? 'üëÅÔ∏è' : 'üôà';
    }
}

// === C√ÅC H√ÄM M·ªöI CHO FULL SCREEN ===
function toggleFullScreen() {
  if (!document.fullscreenElement && !document.webkitFullscreenElement) {
    if (document.documentElement.requestFullscreen) {
      document.documentElement.requestFullscreen();
    } else if (document.documentElement.webkitRequestFullscreen) { // Safari
      document.documentElement.webkitRequestFullscreen();
    }
  } else {
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.webkitExitFullscreen) { // Safari
      document.webkitExitFullscreen();
    }
  }
}

function updateFullscreenButton() {
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    if (!fullscreenBtn) return;

    if (document.fullscreenElement || document.webkitFullscreenElement) {
        fullscreenBtn.textContent = 'Tho√°t Full screen';
    } else {
        fullscreenBtn.textContent = 'Full screen';
    }
}


window.addEventListener("DOMContentLoaded", () => {
  document.getElementById('update-button')?.addEventListener('click', updateWheel);
  document.getElementById('bg-file')?.addEventListener('change', updateBackgroundFromFile);
  document.getElementById('bg-button')?.addEventListener('click', () => document.getElementById('bg-file').click());
  
  document.getElementById('show-zero-quantity')?.addEventListener('change', (e) => {
    showZeroQuantityPrizes = e.target.checked;
    drawWheel();
  });

  document.getElementById('ready-button')?.addEventListener('click', startGame);
  document.getElementById('start-button')?.addEventListener('click', spinWheel);
  document.getElementById('setup-button')?.addEventListener('click', backToSetup);
  document.getElementById('toggle-controls-btn')?.addEventListener('click', toggleControlButtons);
  
  // === TH√äM S·ª∞ KI·ªÜN CHO N√öT FULL SCREEN ===
  document.getElementById('fullscreen-btn')?.addEventListener('click', toggleFullScreen);
  document.addEventListener('fullscreenchange', updateFullscreenButton);
  document.addEventListener('webkitfullscreenchange', updateFullscreenButton); // For Safari

  document.getElementById('download-history')?.addEventListener('click', () => {
    downloadHistoryAsCSV();

    const input = document.getElementById("prize-input").value;
    const initialPrizes = input.split("\n").map(l => {
        const parts = l.split("|").map(x => x.trim());
        return {
            label: parts[0],
            total: parseInt(parts[1] || '0')
        };
    }).filter(p => p.label && !isNaN(p.total));

    const availablePrizes = prizes.filter(p => p.count > 0);
    const totalPoints = availablePrizes.reduce((sum, p) => sum + (p.count * p.weight), 0);

    let report = "Th·ªëng k√™ gi·∫£i th∆∞·ªüng:\n\n";

    initialPrizes.forEach(initialPrize => {
        const currentPrize = prizes.find(p => p.label === initialPrize.label);
        const remainingCount = currentPrize ? currentPrize.count : 0;
        const usedCount = initialPrize.total - remainingCount;

        let probability = 0;
        if (remainingCount > 0 && totalPoints > 0 && currentPrize) {
            const prizePoints = currentPrize.count * currentPrize.weight;
            probability = (prizePoints / totalPoints) * 100;
        }

        report += `${initialPrize.label} - ƒê√£ d√πng: ${usedCount} - C√≤n l·∫°i: ${remainingCount} - T·ªâ l·ªá tr√∫ng: ${probability.toFixed(1)}%\n`;
    });

    const totalRemaining = prizes.reduce((sum, p) => sum + p.count, 0);
    report += `\nT·ªïng gi·∫£i c√≤n l·∫°i: ${totalRemaining}`;
    
    alert(report);
  });
  
  document.getElementById('clear-history')?.addEventListener('click', () => {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô L·ªãch s·ª≠?')) {
      localStorage.removeItem('lich_su_trung_thuong_csv');
      historyData = [];
      document.getElementById("history-list").innerHTML = "";
      document.getElementById("result").textContent = "";
      alert('ƒê√£ x√≥a to√†n b·ªô l·ªãch s·ª≠ quay!');
    }
  });

  spinSound = document.getElementById("spin-sound");

  updateWheel();
  restoreHistoryFromLocalStorage(); 
});

document.addEventListener("keydown", function (e) {
  if (e.key === "F1") {
    e.preventDefault();
    toggleControlButtons();
  }
  if (
    (e.code === "Space" || e.key === " ") &&
    document.getElementById("play").style.display === "flex"
  ) {
    const active = document.activeElement;
    if (
      active.tagName !== "TEXTAREA" &&
      active.tagName !== "INPUT" &&
      active.tagName !== "BUTTON"
    ) {
      e.preventDefault();
      spinWheel();
    }
  }
});


window.addEventListener("beforeunload", function (e) {
  if (historyData.length > 0) {
      e.preventDefault();
      e.returnValue = "";
  }
});
</script>
</body>
</html>
